# RFC #2: 端侧边缘检测与自动裁剪
* **状态**：Draft
* **作者**：DuckRan
* **日期**：2026-02-05
* **目标**：确定移动端文档边缘检测（Edge Detection）与图像矫正（Perspective Correction）的技术方案，确保高质量的 OCR 输入。

---

## 1. 背景与决策

为了配合 **RFC #1** 的“Local-First”策略，图像预处理必须在端侧完成。拍摄质量直接决定了后续 OCR 和 LLM 分析的准确率。我们需要在用户拍摄试卷、笔记时，实时检测纸张边缘，并进行透视变换（把斜拍和扭曲的图片拉直）。

### 1.1 核心原则

* **实时反馈**：在相机预览流中实时叠加检测框（Overlay），引导用户对准。
* **自动化**：支持“稳定自动拍摄”，减少用户手抖影响。
* **隐私与速度**：无需上传服务器裁剪，所有图像矩阵变换在本地 CPU/GPU 完成。

---

## 2. 核心流程：从拍摄到矫正 (Scan to Rectify)

1. **Live Preview (实时流)**：
   * 启动相机流（Camera Stream）。
   * 每一帧（或抽帧）送入边缘检测算法。
   * **UI 反馈**：在屏幕绘制四边形框。若检测不到或置信度低，提示“请靠近”或“背景过乱”。

2. **Capture & Crop (捕获与裁剪)**：
   * **自动/手动触发**：当四角稳定超过 N 帧时自动拍照，或用户点击快门。
   * **获取原图**：保存高分辨率原图。
   * **透视变换**：根据检测到的四个角点，应用透视变换矩阵，输出一张正视视角的图片（Rectified Image）。

3. **Post-Processing (后处理)**：
   * **二值化/增强**：可选步骤，去除阴影，增强对比度（如 Magic Color 滤镜效果），利于后续 OCR。

---

## 3. 技术方案选型

我们需要在性能（FPS）和准确度之间通过权衡。

### 方案 OpenCV / 自研算法 + Flutter UI
使用 `opencv_dart` 或通过 FFI 调用 C++ OpenCV 库。
* **流程**：Canny 边缘检测 -> 轮廓查找 -> 多边形拟合 -> 寻找最大四边形。
* **优点**：完全可控，可以无缝嵌入我们自己的 Flutter 拍照页面，可以自定义“稳定检测”的逻辑。
* **缺点**：开发工作量大，需处理不同光照下的鲁棒性问题，需自行实现透视变换算法。

---

## 4. 数据结构

在本地数据库中，除了存储图片路径，建议存储检测到的元数据，以便后续允许用户“重新裁剪”。

```dart
class ScanMetadata {
  final String originalImagePath; // 原图路径
  final String croppedImagePath;  // 矫正后图路径
  final List<Point> corners;      // 归一化后的四个角点坐标 [TL, TR, BR, BL]
  final double rotation;          // 旋转角度
}
```

---

## 5. 针对团队的讨论要点

1. **自动拍摄的阈值**：如何定义“稳定”？（例如：连续 10 帧角点位移小于 5 像素）。
2. **多页模式**：是否支持连续拍摄多页，最后统一生成 PDF 或长图？
3. **性能开销**：在低端 Android 机型上运行实时边缘检测是否会导致发热或卡顿？是否需要降级策略（如降低处理分辨率）？

---

## 6. 下一步行动建议

1. **UI/UX 设计**：设计扫描后的预览、手动调整角点的交互界面（如果 ML Kit 的默认界面不够用）。
